---
title: Nouvelle √®re de tests E2E avec Playwright
description: Introduction au "nouveau" framework de test End to End
date: 2021-11
separator: <!--s-->
verticalSeparator: <!--v-->
---
# Nouvelle √®re de tests E2E avec Playwright 

ü§ñ

<!--s-->

1. Intro
2. Webdriver vs DevsTools 
3. Playwright 
4. Features 
5. D√©mo 

<!--s-->
## Usecase

<!--v-->
- Qualifier l'installation d'une application web
  - Tests de non regression
  - Tests acceptance
- Automatiser les "clicks button" sur les √©crans

<!--s-->
## Webdriver

<!--v-->
![web driver architecture](attachments/playwright_webdriver.svg) 

* LE standard (W3C) <!-- .element: class="fragment" -->
* Cross Browser <!-- .element: class="fragment" -->

Note: Dans l'achitecture classique, le client (node, java, autre) parle au navigateur par l'interm√©diaire du webdriver.

Le webdriver interpr√®te les requ√™tes et se charge de l'envoyer au navigateur.
C'est √† ce jour le standard le plus repandu et utilis√© par de nombreux framework (cypress, fitness, robot)

<!--v-->
Mais: 
- Client et Serveur peuvent se d√©synchroniser (‚ö†Ô∏ètiming / lenteurs)
- Limitations du webdriver vs le navigateur

_note perso: √©crire des tests selenium est une gal√®re..._

<!--s-->
## Devtools

<!--v-->
![devtools architecture](attachments/playwright_devtools.svg) 

- Pas de middle man <!-- .element: class="fragment" -->
- Plus rapide et stable (?) <!-- .element: class="fragment" -->
- "Limit√©" par le protocol: g√©olocation, mobile, network interception, ... <!-- .element: class="fragment" -->

Note: tracing, audit, profiler ?

<!--v-->
Mais:

- Pas "encore" un standard (CDP = Chrome Dev Tools)
  - Tous les navigateurs ne l'impl√©mente pas (ou pas de la m√™me fa√ßon)

<!--s-->
## Playwright
<!--v-->
- 1.O.O en 2020
- D√©velopp√© par Microsoft : https://github.com/microsoft/playwright
  - Ancien √©quipe en charge de puppeteer <!-- .element: class="fragment" -->
- Multi-language <!-- .element: class="fragment" -->
  - typescript principalement <!-- .element: class="fragment" -->
  - java, python, .Net <!-- .element: class="fragment" -->
- Se base principalement sur le protocole DevTools <!-- .element: class="fragment" -->

<!--v-->

- Gestion de sc√©narios avec multiples pages, domaines, iframe
- Auto-wait sur les √©l√©ments avant d'√©xecuter certaines actions (button, input)
- Interception des appels r√©seaux pour mocker les r√©sultats, voir r√©diriger 
- Emulation mobiles, geolocalisation, permissions

<!--v-->
- Support de web components (shadow-dom compatible)
- Support du upload / dowload de fichier
- Screenshot, videos, tracing, recorder

<!--s-->

## Installation
<!--v-->
```xml
 <dependency>
    <groupId>com.microsoft.playwright</groupId>
    <artifactId>playwright</artifactId>
    <version>${playwright.version}</version>
</dependency>
```

<!--s-->
## Examples / D√©mos

<!--s-->
CodeGen
```powershell
mvn exec:java -e "-Dexec.mainClass=com.microsoft.playwright.CLI" "-Dexec.args=codegen https://google.com"
```
- Ouvre un navigateur en mode priv√©
- Enregistre tout ce que fait l'utilisateur
- G√©n√®re le code correspondant üî•
<!--v-->
![codegen](attachments/playwright_recorder.JPG) <!-- .element height="60%" width="60%" -->

<!--s-->
Debug
```java
try (Playwright playwright = Playwright.create()) {
    ...
  BrowserContext context = browser.newContext();
  
  // Open new page
  Page page = context.newPage();
  
  page.pause();
  
  // Go to https://www.google.com/
  page.navigate("https://www.google.com/");
}
```

<!--v-->
```powershell
set PLAYWRIGHT_JAVA_SRC=<java src root>
set PWDEBUG=1
mvn test
```

<!--v-->

![inspector](attachments/playwright_inspector.png) <!-- .element height="60%" width="60%" -->

<!--s-->
Network interception

```java 
// Mock network
page.route("**/api", route -> route.fulfill(
  new Route.FulfillOptions()
  .setStatus(200)
  .setBody("Hello World!")));

page.navigate("https://example.com/api");

assertTrue(page.content().contains("Hello World!"));
```

Note: Tr√®s utile pour
- Tracer/ logguer les appels entrant/sortant
- Intercepter et simuler une r√©ponse
- Cela peut aussi √©couter les websockets

<!--s-->
## Tracing > Screenshot + Vid√©os

<!--v-->

```java
page.screenshot(
        new Page.ScreenshotOptions()
                .setPath(Paths.get("screenshot.png")) 
                .setFullPage(true));
// ou
byte[] buffer = page.screenshot();
System.out.println(Base64.getEncoder().encode(buffer));
```

Note: On peut faire aussi un screenshot depuis un √©l√©ment en fournissant un selecteur

<!--v-->

```java
context = browser.newContext(
        new Browser.NewContextOptions().
                    setRecordVideoDir(Paths.get("videos/")));
// Make sure to close, so that videos are saved.
context.close();
```

<!--v-->

```java
Browser browser = browserType.launch();
BrowserContext context = browser.newContext();

// Start tracing before creating / navigating a page.
context.tracing().start(new Tracing.StartOptions()  
                    .setScreenshots(true)  
                    .setSnapshots(true));

Page page = context.newPage();
// Do some testing/navigating

// Stop tracing and export it into a zip archive.
context.tracing().stop( new Tracing.StopOptions()
        .setPath(Paths.get("trace.zip")));
```

Note: 
`mvn exec:java -e "-Dexec.mainClass=com.microsoft.playwright.CLI" "-Dexec.args=show-trace target/trace.zip"`

<!--s-->
# Reporting

- En cours (typescript seulement)
- Int√©gration avec Allure

<!--s-->
R√©f√©rences:

- Playwright:
  - Repo: https://github.com/microsoft/playwright
  - Docs: https://playwright.dev/java/

- Autres:
  - Slides: https://mikomatic.github.io/presentations/playwright.html#/
  - D√©mo: https://github.com/mikomatic/playwright-demo